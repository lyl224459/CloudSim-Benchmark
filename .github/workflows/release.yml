name: Release Build

on:
  # 禁用此工作流，只使用 release-auto.yml
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: true
        default: '1.0.0'

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 23
      uses: actions/setup-java@v4
      with:
        java-version: '23'
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    # Windows 环境，不需要设置执行权限
      
    - name: Build with Gradle
      run: .\gradlew.bat clean build --no-daemon --stacktrace --info
      env:
        GRADLE_OPTS: "-Dfile.encoding=UTF-8"
      continue-on-error: false
        
    - name: Build fat JAR
      run: .\gradlew.bat fatJar --no-daemon --stacktrace
      env:
        GRADLE_OPTS: "-Dfile.encoding=UTF-8"
      continue-on-error: false
      
    - name: Get version
      id: version
      shell: pwsh
      run: |
        $output = & .\gradlew.bat properties --no-daemon
        $versionLine = $output | Select-String -Pattern "^version:"
        $version = ($versionLine -split '\s+')[1]
        echo "version=$version" >> $env:GITHUB_OUTPUT
        
    - name: Create release archives
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path release | Out-Null
        # 复制 JAR 文件
        Copy-Item -Path build/libs/cloudsim-benchmark-*.jar -Destination release/
        # 创建 Windows ZIP 压缩包（包含 JAR）
        Compress-Archive -Path release\*.jar -DestinationPath "release\cloudsim-benchmark-${{ steps.version.outputs.version }}-windows.zip" -Force
        # 创建源码压缩包
        $files = @(
          'src',
          'build.gradle.kts',
          'gradle',
          'gradlew',
          'gradlew.bat',
          'settings.gradle.kts',
          'README.md',
          'LICENSE',
          '.gitignore'
        )
        $exclude = @('build', '.gradle', '.idea', 'results')
        $tempDir = 'source-temp'
        New-Item -ItemType Directory -Force -Path $tempDir | Out-Null
        foreach ($file in $files) {
          if (Test-Path $file) {
            Copy-Item -Path $file -Destination $tempDir -Recurse -Force
          }
        }
        # 删除排除的目录和文件
        foreach ($ex in $exclude) {
          $exPath = Join-Path $tempDir $ex
          if (Test-Path $exPath) {
            Remove-Item -Path $exPath -Recurse -Force
          }
        }
        # 删除 .class 和 .iml 文件
        Get-ChildItem -Path $tempDir -Recurse -Include *.class,*.iml | Remove-Item -Force
        Compress-Archive -Path "$tempDir\*" -DestinationPath "release\cloudsim-benchmark-${{ steps.version.outputs.version }}-source.zip" -Force
        Remove-Item -Path $tempDir -Recurse -Force
        Get-ChildItem -Path release | Format-Table Name, Length
        
    - name: Upload release assets
      uses: actions/upload-artifact@v4
      with:
        name: release-assets
        path: release/*
        retention-days: 90

