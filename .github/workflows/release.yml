name: Release - Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å· (ä¾‹å¦‚ 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build, Package and Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up JDK 23
      uses: actions/setup-java@v4
      with:
        java-version: '23'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Build Fat JAR (Compressed)
      run: .\gradlew.bat clean fatJar --no-daemon -Pcompress=true
      env:
        GRADLE_OPTS: "-Dfile.encoding=UTF-8"
        CI: "true"

    - name: Prepare Release Version
      id: ver
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT

    - name: Package Release Assets
      shell: pwsh
      run: |
        $version = "${{ steps.ver.outputs.version }}"
        $releaseDir = "release-artifacts"
        New-Item -ItemType Directory -Force -Path $releaseDir
        
        # 1. å¤åˆ¶ JAR
        $jar = Get-ChildItem -Path build/libs/cloudsim-benchmark-*-all.jar | Select-Object -First 1
        Copy-Item -Path $jar.FullName -Destination "$releaseDir/cloudsim-benchmark-$version.jar"
        
        # 2. åˆ›å»º Windows å®Œæ•´åŒ… (å«è„šæœ¬ã€é…ç½®å’Œ JAR)
        $winDir = "cloudsim-benchmark-$version-windows"
        New-Item -ItemType Directory -Force -Path $winDir
        Copy-Item -Path $jar.FullName -Destination "$winDir/cloudsim-benchmark-all.jar"
        Copy-Item -Path "run.cmd", "configs", "data", "README.md", "LICENSE" -Destination $winDir -Recurse -Force
        Compress-Archive -Path "$winDir\*" -DestinationPath "$releaseDir/cloudsim-benchmark-$version-windows.zip" -Force
        
        # 3. åˆ›å»ºæºç åŒ…
        Compress-Archive -Path "src", "configs", "data", "*.gradle.kts", "gradle.properties", "gradle", "gradlew*", "Containerfile", "README.md", "LICENSE" -DestinationPath "$releaseDir/cloudsim-benchmark-$version-source.zip" -Force

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.ver.outputs.tag }}
        name: CloudSim-Benchmark v${{ steps.ver.outputs.version }}
        body: |
          ## ğŸš€ CloudSim-Benchmark ${{ steps.ver.outputs.tag }} å‘å¸ƒ
          
          ### ğŸ“¦ åŒ…å«äº§ç‰©
          - **Executable JAR**: åŒ…å«æ‰€æœ‰ä¾èµ–ï¼Œç›´æ¥é€šè¿‡ `java -jar` è¿è¡Œã€‚
          - **Windows Package**: åŒ…å«ä¾¿æ·è¿è¡Œè„šæœ¬å’Œé»˜è®¤é…ç½®ã€‚
          - **Source Code**: å®Œæ•´å¼€å‘ç¯å¢ƒæºç ã€‚
          
          ### ğŸ› ï¸ è¿è¡Œç¯å¢ƒ
          - JDK 23+ (æ¨è)
          
          ### ğŸ³ å®¹å™¨é•œåƒ
          æœ¬ç‰ˆæœ¬å·²åŒæ­¥å‘å¸ƒè‡³ GitHub Container Registry:
          `ghcr.io/${{ github.repository_owner }}/cloudsim-benchmark:${{ steps.ver.outputs.version }}`
        draft: false
        prerelease: false
        files: |
          release-artifacts/*.jar
          release-artifacts/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-docker:
    name: Build and Push Docker Image
    needs: build-and-release
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=semver,pattern={{version}}
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Containerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
