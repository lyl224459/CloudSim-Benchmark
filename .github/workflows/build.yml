name: Build and Package

on:
  # 禁用此工作流，只使用 release-auto.yml
  workflow_dispatch:
    # 手动触发构建（仅用于测试）

env:
  GRADLE_OPTS: "-Dfile.encoding=UTF-8"

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 23
      uses: actions/setup-java@v4
      with:
        java-version: '23'
        distribution: 'temurin'
        cache: 'gradle'
        
    # Gradle 缓存已由 setup-java 的 cache: 'gradle' 自动处理
          
    - name: Build with Gradle
      run: .\gradlew.bat clean build --no-daemon --stacktrace
      env:
        GRADLE_OPTS: "-Dfile.encoding=UTF-8"
        
    - name: Build fat JAR
      run: .\gradlew.bat fatJar --no-daemon --stacktrace
      env:
        GRADLE_OPTS: "-Dfile.encoding=UTF-8"
      
    - name: Create source archive
      shell: pwsh
      run: |
        $files = @(
          'src',
          'build.gradle.kts',
          'gradle',
          'gradlew',
          'gradlew.bat',
          'settings.gradle.kts',
          'README.md',
          'LICENSE',
          '.gitignore'
        )
        $exclude = @('build', '.gradle', '.idea', 'results')
        $tempDir = 'source-temp'
        New-Item -ItemType Directory -Force -Path $tempDir | Out-Null
        foreach ($file in $files) {
          if (Test-Path $file) {
            Copy-Item -Path $file -Destination $tempDir -Recurse -Force
          }
        }
        # 删除排除的目录和文件
        foreach ($ex in $exclude) {
          $exPath = Join-Path $tempDir $ex
          if (Test-Path $exPath) {
            Remove-Item -Path $exPath -Recurse -Force
          }
        }
        # 删除 .class 和 .iml 文件
        Get-ChildItem -Path $tempDir -Recurse -Include *.class,*.iml | Remove-Item -Force
        Compress-Archive -Path "$tempDir\*" -DestinationPath "source.zip" -Force
        Remove-Item -Path $tempDir -Recurse -Force
    
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: cloudsim-benchmark-jar
        path: build/libs/cloudsim-benchmark-*.jar
        retention-days: 30
        
    - name: Upload source archive
      uses: actions/upload-artifact@v4
      with:
        name: cloudsim-benchmark-source
        path: source.zip
        retention-days: 30
        
    - name: Upload build reports
      uses: actions/upload-artifact@v4
      if: always()
      continue-on-error: true
      with:
        name: build-reports
        path: |
          build/reports/
          build/test-results/
        retention-days: 7
        if-no-files-found: ignore

